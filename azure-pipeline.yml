trigger:
  branches:
    include:
      - main

pool:
  name: sandbox
  demands: agent.name -equals vm-devops-runner-sandbox

parameters:
  - name: environment
    displayName: 'Target Environment'
    type: string
    default: 'sandbox'
    values:
      - sandbox
      - test
      - stage
      - prod

variables:
  - group: acr_secret_sandbox

  - ${{ if eq(parameters.environment, 'test') }}:
      - group: acr_secret_test
  - ${{ if eq(parameters.environment, 'stage') }}:
      - group: acr_secret_stg
  - ${{ if eq(parameters.environment, 'prod') }}:
      - group: acr_secret_prod

  - name: sourceImageName
    value: 'govgpt'

resources:
  repositories:
    - repository: gitops
      type: git
      name: AIFactory/gitops
      ref: refs/heads/main

steps:
- checkout: self
- checkout: gitops

# ACR Login
- script: |
    echo $(dockerRegistryPassword) | docker login $(dockerRegistryUrl) -u $(dockerRegistryUsername) --password-stdin
  displayName: 'Authenticate to ACR'

# # Build Docker Image
# - script: |
#     docker build -t $(dockerRegistryUrl)/$(sourceImageName):latest \
#                  -t $(dockerRegistryUrl)/$(sourceImageName):$(Build.BuildId) \
#                  -f Dockerfile .
#   displayName: 'Build Docker Image'

# # Push Docker Image to ACR
# - script: |
#     docker push $(dockerRegistryUrl)/$(sourceImageName):latest
#     docker push $(dockerRegistryUrl)/$(sourceImageName):$(Build.BuildId)
#   displayName: 'Push Docker Image to ACR'

# Update sandbox.yaml in GitOps repo
- script: |
    echo "Installing yq..."

    echo "Updating image tag in sandbox.yaml to $(Build.BuildId)"
    cd gitops/helm-charts/govgpt
    yq e '.image.tag = "$(Build.BuildId)"' -i sandbox.yaml

    git config user.name "Azure Pipeline"
    git config user.email "pipeline@azure.gitops"
    git add sandbox.yaml
    git commit -m "chore: bump govgpt tag to $(Build.BuildId)"

    # Use access token for pushing
    git remote set-url origin https://$(System.AccessToken)@dev.azure.com/ADGOV-AI/AIFactory/_git/gitops
    git push origin HEAD:main
  displayName: 'Update Helm image tag in GitOps repo'
  env:
    SYSTEM_ACCESSTOKEN: $(System.AccessToken)

